<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Salesforce JWT Certificate Tool</title>
    <style>
        :root {
            --ax-text-neutral: #262626;
            --ax-text-subtle: #6a6a6a;
            --ax-text-danger-decoration: #c30000;

            --ax-bg-danger: #c30000;
            --ax-bg-danger-hover: #a80000;
            --ax-bg-danger-active: #8f0000;
            --ax-text-on-danger: #ffffff;

            --ax-bg-hover: rgba(0, 0, 0, 0.06);
            --ax-bg-active: rgba(0, 0, 0, 0.12);

            --ax-focus-ring: #005bff;

            --ax-radius-small: 4px;
            --ax-spacing-2: 0.5rem;
        }

        .aksel-button {
            appearance: none;
            border: none;
            background: none;
            color: var(--ax-text-neutral);
            border-radius: var(--ax-radius-small);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--ax-spacing-2);
            gap: 0.5rem; /* space between icon and label */
        }

        .aksel-button--small {
            padding: 0.375rem 0.75rem;
        }


        .aksel-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .aksel-button--tertiary {
            background: transparent;
            color: var(--ax-text-neutral);
        }

        .aksel-button--icon-only {
            width: 2rem;
            height: 2rem;
        }

        .aksel-button--tertiary:hover {
            background: var(--ax-bg-hover);
        }

        .aksel-button--tertiary:active {
            background: var(--ax-bg-active);
        }

        .aksel-button--danger {
            background: var(--ax-bg-danger);
            color: var(--ax-text-on-danger);
        }

        .aksel-button--danger:hover {
            background: var(--ax-bg-danger-hover);
        }

        .aksel-button--danger:active {
            background: var(--ax-bg-danger-active);
        }




        .aksel-button:focus-visible {
            outline: 2px solid var(--ax-focus-ring);
            outline-offset: 2px;
        }

        .aksel-button__icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .aksel-button__icon svg {
            width: 2rem;
            height: 2rem;
            color: currentColor;
            flex-shrink: 0;
        }

        .aksel-button--tertiary-neutral {
            color: var(--ax-text-danger-decoration);
        }

        .aksel-button--tertiary-neutral:hover {
            background: rgba(195, 0, 0, 0.08);
        }

        .aksel-label {
            font-family: inherit;
            font-weight: 400;
            line-height: 1.25;
        }

        .aksel-label--small {
            font-size: 0.875rem; /* ~14px */
        }





        /* ---------- Base ---------- */

        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 2em;
            color: #333;
        }

        h2 {
            margin-top: 0;
            color: #0e2a3d;
        }

        /* ---------- Forms & Inputs ---------- */

        input {
            margin: 0.3em 0;
            width: 100%;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        input:focus {
            outline: none;
            border-color: #3498db;
        }

        /* ---------- Buttons ---------- */

        button {
            margin-top: 0.5em;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 6px 12px;
            cursor: pointer;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #9dbbd8;
            cursor: not-allowed;
        }

        /* ---------- Spinner ---------- */

        #generateSpinner {
            margin-top: 0.5em;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #555;
        }

        #generateSpinner::before {
            content: "";
            width: 16px;
            height: 16px;
            border: 3px solid #e0e0e0;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ---------- Table ---------- */

        table {
            border-collapse: collapse;
            margin-top: 1em;
            width: 100%;
            background: #ffffff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .copywidth {
            width: 50px;
        }

        th {
            background-color: #3498db;
            color: white;
            font-weight: normal;
        }

        tbody tr:nth-child(odd) {
            background-color: #f7faff;
        }

        tbody tr:hover {
            background-color: #eef5ff;
        }

        .warn {
            color: #b00020;
            font-weight: bold;
        }

        /* ---------- Icon Buttons ---------- */

        td {
            text-align: center;
            vertical-align: middle;
        }

        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;

            min-width: 36px;
            padding: 6px 10px;

            font-size: 1.1em;
            cursor: pointer;

            background-color: #eef5ff;
            border: 1px solid #cfe1f7;
            border-radius: 6px;

            color: #0e2a3d;
            transition:
                    background-color 0.15s ease,
                    box-shadow 0.15s ease,
                    transform 0.05s ease;
        }

        .icon-btn:hover {
            background-color: #dbeeff;
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
        }

        .icon-btn:active {
            transform: translateY(1px);
        }

        .icon-btn:disabled {
            background-color: #f0f0f0;
            border-color: #ddd;
            color: #aaa;
            cursor: not-allowed;
        }

        /* If the icon button is the ONLY thing in the cell, stretch it */
        td > .icon-btn:only-child {
            width: 100%;
        }
        .icon-btn:hover {
            background-color: rgba(52, 152, 219, 0.15);
        }

        /* ---------- Modals ---------- */

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
        }

        .modal-content {
            background: #ffffff;
            max-width: 420px;
            margin: 10% auto;
            padding: 1.2em;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        }

        .modal-content h3 {
            margin-top: 0;
            color: #0e2a3d;
        }

        .modal-actions {
            margin-top: 1.2em;
            display: flex;
            justify-content: space-between;
        }

        /* ---------- Results ---------- */

        .success {
            background-color: #e8f5e9;
            border: 1px solid #4caf50;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
        }

        .error {
            background-color: #ffebee;
            border: 1px solid #e57373;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            white-space: pre-wrap;
        }

        /* ---------- Toast ---------- */

        #toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 0.6em 1em;
            border-radius: 6px;
            display: none;
            z-index: 2000;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .verify-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid currentColor;
            border-radius: 50%;
            position: relative;
        }

        /* The checkmark */
        .verify-icon.verified::after {
            background: red;
            content: "";
            position: absolute;
            display: block;

            left: 5px;
            top: 2px;

            width: 4px;
            height: 8px;

            border-right: 2px solid currentColor;
            border-bottom: 2px solid currentColor;
            transform: rotate(45deg);
        }

        .verify-btn { color: #777; }              /* unverified */
        .verify-btn.verified { color: #1e7e34; }  /* verified green */


    </style>

</head>
<body>

<h2>Generate Salesforce JWT Certificate</h2>

<form id="generateForm">
    <div>
        CN:
        <input name="cn" required placeholder="common name" />
    </div>
    <div>
        Validity days:
        <input name="days" value="1200" />
    </div>
    <button type="submit">Generate</button>
    <div id="generateSpinner" style="display:none;">
        ‚è≥ Generating certificate‚Ä¶
    </div>
</form>

<hr/>

<h2>Existing certificates</h2>
<button onclick="loadCerts()">Refresh</button>

<table>
    <thead>
    <tr>
        <th>CN</th>
        <th>Expires</th>
        <th>Days left</th>
        <th class="copywidth">Cert file</th>
        <th class="copywidth">KEYSTORE_JKS_B64</th>
        <th class="copywidth">KEYSTORE_PASSWORD</th>
        <th>Verify</th>
        <th class="copywidth">SF_CLIENT_ID</th>
        <th class="copywidth">SF_USERNAME</th>
        <th></th>
    </tr>
    </thead>
    <tbody id="certTable"></tbody>
</table>

<br>
<br>
<button onclick="flushLocal()" title="Flush local secrets" data-color="danger" data-variant="primary" class="delete-secret aksel-button aksel-button--danger aksel-button--small"><span class="aksel-button__icon"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" focusable="false" role="img" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" fill-rule="evenodd" d="M4.5 6.25a.75.75 0 0 0 0 1.5h.805l.876 11.384a1.75 1.75 0 0 0 1.745 1.616h8.148a1.75 1.75 0 0 0 1.745-1.616l.876-11.384h.805a.75.75 0 0 0 0-1.5h-2.75V6A2.75 2.75 0 0 0 14 3.25h-4A2.75 2.75 0 0 0 7.25 6v.25zm5.5-1.5c-.69 0-1.25.56-1.25 1.25v.25h6.5V6c0-.69-.56-1.25-1.25-1.25zm-3.19 3 .867 11.27c.01.13.118.23.249.23h8.148c.13 0 .24-.1.25-.23l.866-11.27zm3.19 2a.75.75 0 0 1 .75.75v6a.75.75 0 0 1-1.5 0v-6a.75.75 0 0 1 .75-.75m4 0a.75.75 0 0 1 .75.75v6a.75.75 0 0 1-1.5 0v-6a.75.75 0 0 1 .75-.75" clip-rule="evenodd"></path></svg></span><span class="aksel-label aksel-label--small">Flush Local</span></button>

<!-- Test Modal -->
<div id="testModal" class="modal">
    <div class="modal-content">
        <h3>Test certificate</h3>

        <div>
            CN:
            <input id="testCn" readonly />
        </div>

        <div>
            Salesforce Client ID:
            <input id="testClientId" />
        </div>

        <div>
            Salesforce Username:
            <input id="testUsername" />
        </div>

        <div id="testResult"></div>

        <div class="modal-actions">
            <button onclick="runTest()">Test</button>
            <button onclick="closeModal()">Close</button>
        </div>
    </div>
</div>
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <h3 id="confirmTitle"></h3>
        <p id="confirmMessage"></p>

        <div class="modal-actions">
            <button type="button" onclick="closeConfirmModal()">Cancel</button>
            <button type="button" id="confirmOkButton">Confirm</button>
        </div>
    </div>
</div>
<div id="toast" style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #333;
    color: white;
    padding: 0.6em 1em;
    border-radius: 4px;
    display: none;
    z-index: 1000;
"></div>

<script>
    let currentTestCn = null;
    let existingCns = new Set();

    async function loadCerts() {
        const res = await fetch("/internal/cert/list");
        const list = await res.json();

        const tbody = document.getElementById("certTable");
        tbody.innerHTML = "";

        existingCns.clear()
        list.forEach(c => {
            existingCns.add(c.cn);

            const tr = document.createElement("tr");
            const warn = c.daysLeft < 60 ? "warn" : "";

            const isTmp = c.source === "tmp";

            const isVerified = !!(c.sfClientId && c.sfUsername);

            tr.innerHTML = `
  <td>${c.cn}</td>
  <td>${c.expiresAt}</td>
  <td class="${warn}">${c.daysLeft}</td>

      <td>
        ${isTmp
                ? `<button class="icon-btn" title="Download certificate"
                 onclick="download('${c.cn}', 'cer')">‚¨áÔ∏è</button>`
                : ``}
      </td>
      <td>
        ${isTmp
                ? `<button title="Copy JKS Base64" onclick="copy('${c.cn}', 'jksb64')" type="button" data-active="false" data-variant="tertiary" class="aksel-copybutton aksel-button aksel-button&#45;&#45;tertiary aksel-button&#45;&#45;small aksel-button&#45;&#45;icon-only"><span class="aksel-button__icon"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" focusable="false" role="img" viewBox="0 0 24 24" aria-labelledby="c267" aria-hidden="false" class="aksel-copybutton__icon"><title id="c267">Copy</title><path fill="currentColor" fill-rule="evenodd" d="M8.25 3.5c0-.69.56-1.25 1.25-1.25H14a.75.75 0 0 1 .53.22l5 5c.141.14.22.331.22.53v8.5c0 .69-.56 1.25-1.25 1.25h-9c-.69 0-1.25-.56-1.25-1.25zm6.25 5.25c-.69 0-1.25-.56-1.25-1.25V3.75h-3.5v12.5h8.5v-7.5zm.25-3.94 2.44 2.44h-2.44zM6.502 7.75H5.75v12.5h8.5v-.748a.75.75 0 0 1 1.5 0v.998c0 .69-.56 1.25-1.25 1.25h-9c-.69 0-1.25-.56-1.25-1.25v-13c0-.69.56-1.25 1.25-1.25h1.002a.75.75 0 1 1 0 1.5" clip-rule="evenodd"></path></svg></span>  </button>`
                : ``}
      </td>

      <td>
        ${isTmp
                ? `<button title="Copy JKS keystore password" onclick="copy('${c.cn}', 'password')" type="button" data-active="false" data-variant="tertiary" class="aksel-copybutton aksel-button aksel-button&#45;&#45;tertiary aksel-button&#45;&#45;small aksel-button&#45;&#45;icon-only"><span class="aksel-button__icon"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" focusable="false" role="img" viewBox="0 0 24 24" aria-labelledby="c267" aria-hidden="false" class="aksel-copybutton__icon"><title id="c267">Copy</title><path fill="currentColor" fill-rule="evenodd" d="M8.25 3.5c0-.69.56-1.25 1.25-1.25H14a.75.75 0 0 1 .53.22l5 5c.141.14.22.331.22.53v8.5c0 .69-.56 1.25-1.25 1.25h-9c-.69 0-1.25-.56-1.25-1.25zm6.25 5.25c-.69 0-1.25-.56-1.25-1.25V3.75h-3.5v12.5h8.5v-7.5zm.25-3.94 2.44 2.44h-2.44zM6.502 7.75H5.75v12.5h8.5v-.748a.75.75 0 0 1 1.5 0v.998c0 .69-.56 1.25-1.25 1.25h-9c-.69 0-1.25-.56-1.25-1.25v-13c0-.69.56-1.25 1.25-1.25h1.002a.75.75 0 1 1 0 1.5" clip-rule="evenodd"></path></svg></span>  </button>`
                : ``}
      </td>

      <td>
        ${isTmp
                ? `<button class="icon-btn verify-btn ${isVerified ? `verified` : ``}" title="Verify against Salesforce"
                 onclick="openTestModal('${c.cn}')"><span class="verify-icon"></span></button>`
                : ``}
      </td>

      <td>
  ${
                isTmp && c.sfClientId
                    ? `<button title="Copy SF Client ID" onclick="copyValue('${c.sfClientId}')" type="button" data-active="false" data-variant="tertiary" class="aksel-copybutton aksel-button aksel-button&#45;&#45;tertiary aksel-button&#45;&#45;small aksel-button&#45;&#45;icon-only"><span class="aksel-button__icon"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" focusable="false" role="img" viewBox="0 0 24 24" aria-labelledby="c267" aria-hidden="false" class="aksel-copybutton__icon"><title id="c267">Copy</title><path fill="currentColor" fill-rule="evenodd" d="M8.25 3.5c0-.69.56-1.25 1.25-1.25H14a.75.75 0 0 1 .53.22l5 5c.141.14.22.331.22.53v8.5c0 .69-.56 1.25-1.25 1.25h-9c-.69 0-1.25-.56-1.25-1.25zm6.25 5.25c-.69 0-1.25-.56-1.25-1.25V3.75h-3.5v12.5h8.5v-7.5zm.25-3.94 2.44 2.44h-2.44zM6.502 7.75H5.75v12.5h8.5v-.748a.75.75 0 0 1 1.5 0v.998c0 .69-.56 1.25-1.25 1.25h-9c-.69 0-1.25-.56-1.25-1.25v-13c0-.69.56-1.25 1.25-1.25h1.002a.75.75 0 1 1 0 1.5" clip-rule="evenodd"></path></svg></span>  </button>`
                    : (!isTmp && c.sfClientId
                        ? `<span title="Masked Client ID">${c.sfClientId}</span>`
                        : ``)
            }
</td>

      <td>
  ${
                isTmp && c.sfUsername
                    ? `<button title="Copy SF Username" onclick="copyValue('${c.sfUsername}')" type="button" data-active="false" data-variant="tertiary" class="aksel-copybutton aksel-button aksel-button&#45;&#45;tertiary aksel-button&#45;&#45;small aksel-button&#45;&#45;icon-only"><span class="aksel-button__icon"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" focusable="false" role="img" viewBox="0 0 24 24" aria-labelledby="c267" aria-hidden="false" class="aksel-copybutton__icon"><title id="c267">Copy</title><path fill="currentColor" fill-rule="evenodd" d="M8.25 3.5c0-.69.56-1.25 1.25-1.25H14a.75.75 0 0 1 .53.22l5 5c.141.14.22.331.22.53v8.5c0 .69-.56 1.25-1.25 1.25h-9c-.69 0-1.25-.56-1.25-1.25zm6.25 5.25c-.69 0-1.25-.56-1.25-1.25V3.75h-3.5v12.5h8.5v-7.5zm.25-3.94 2.44 2.44h-2.44zM6.502 7.75H5.75v12.5h8.5v-.748a.75.75 0 0 1 1.5 0v.998c0 .69-.56 1.25-1.25 1.25h-9c-.69 0-1.25-.56-1.25-1.25v-13c0-.69.56-1.25 1.25-1.25h1.002a.75.75 0 1 1 0 1.5" clip-rule="evenodd"></path></svg></span>  </button>`
                    : (!isTmp && c.sfUsername
                        ? `<span title="Integration user">${c.sfUsername}</span>`
                        : ``)
            }
</td>
      <td>
  <button class="icon-btn" title="Delete certificate"
    onclick="deleteCert('${c.cn}', '${c.source}')">üóë</button>
</td>
`;
            tbody.appendChild(tr);
        });
    }

    function copyValue(value) {
        navigator.clipboard.writeText(value);
        showToast("Copied to clipboard");
    }

    function download(cn, type) {
        window.location = `/internal/cert/download/${cn}/${type}`;
    }

    async function copy(cn, type) {
        const res = await fetch(`/internal/cert/download/${cn}/${type}`);
        const text = await res.text();
        await navigator.clipboard.writeText(text);
        showToast("Copied to clipboard");
    }

    /* ----- Modal ----- */

    function openTestModal(cn) {
        currentTestCn = cn;
        document.getElementById("testCn").value = cn;
        document.getElementById("testResult").innerHTML = "";
        document.getElementById("testModal").style.display = "block";
    }

    function closeModal() {
        document.getElementById("testModal").style.display = "none";
    }

    function showToast(msg) {
        const t = document.getElementById("toast");
        t.textContent = msg;
        t.style.display = "block";

        setTimeout(() => {
            t.style.display = "none";
        }, 1500);
    }

    async function runTest() {
        const clientId = document.getElementById("testClientId").value;
        const username = document.getElementById("testUsername").value;

        const result = document.getElementById("testResult");
        result.textContent = "Testing...";
        result.className = "";

        const body = new URLSearchParams({
            cn: currentTestCn,
            clientId,
            username
        });

        const res = await fetch("/internal/cert/test", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body
        });

        const text = await res.text();
        result.textContent = text;
        result.className = res.ok ? "success" : "error";
        await loadCerts();
    }

    function deleteCert(cn, source) {
        openConfirmModal(
            "Delete certificate",
            `Delete certificate '${cn}'?\n\nThis cannot be undone.`,
            async () => {
                console.log("DELETE CERT delegated function");
                const body = new URLSearchParams({ cn, source });

                const res = await fetch("/internal/cert/delete", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body
                });

                if (!res.ok) {
                    showToast(await res.text());
                    return;
                }

                await loadCerts();
            }
        );
    }

    function flushLocal() {
        openConfirmModal(
            "Flush local certificate cache",
            "This will remove ALL locally stored certificates and secrets.\n\n" +
            "Database metadata will remain.",
            async () => {
                const res = await fetch("/internal/cert/flush", {
                    method: "POST"
                });

                if (!res.ok) {
                    showToast(await res.text());
                    return;
                }

                await loadCerts();
            }
        );
    }

    let confirmCallback = null;

    function openConfirmModal(title, message, onConfirm) {
        document.getElementById("confirmTitle").innerText = title;
        document.getElementById("confirmMessage").innerText = message;

        confirmCallback = onConfirm;

        document.getElementById("confirmModal").style.display = "block";

        document.getElementById("confirmOkButton").onclick = () => {
            const cb = confirmCallback;
            closeConfirmModal();
            cb && cb();
        };
    }

    function closeConfirmModal() {
        document.getElementById("confirmModal").style.display = "none";
        confirmCallback = null;
    }


    /* ----- Generate ----- */

    document.getElementById("generateForm").onsubmit = async e => {
        e.preventDefault();
        const f = e.target;
        const spinner = document.getElementById("generateSpinner");
        const cn = f.cn.value.trim();

        if (existingCns.has(cn)) {
            showToast(`Certificate with CN '${cn}' already exists`);
            return;
        }

        spinner.style.display = "block";
        f.querySelector("button").disabled = true;

        const body = new URLSearchParams({
            cn: cn,
            days: f.days.value
        });

        try {
            const res = await fetch("/internal/cert/generate", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body
            });

            if (!res.ok) {
                showToast(await res.text());
            } else {
                f.reset();
                await loadCerts();
            }
        } finally {
            spinner.style.display = "none";
            f.querySelector("button").disabled = false;
        }
    };

    loadCerts();
</script>
</body>
</html>
