<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Salesforce JWT Certificate Tool</title>
    <style>
        /* ---------- Base ---------- */

        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 2em;
            color: #333;
        }

        h2 {
            margin-top: 0;
            color: #0e2a3d;
        }

        /* ---------- Forms & Inputs ---------- */

        input {
            margin: 0.3em 0;
            width: 100%;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        input:focus {
            outline: none;
            border-color: #3498db;
        }

        /* ---------- Buttons ---------- */

        button {
            margin-top: 0.5em;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 6px 12px;
            cursor: pointer;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #9dbbd8;
            cursor: not-allowed;
        }

        /* ---------- Spinner ---------- */

        #generateSpinner {
            margin-top: 0.5em;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #555;
        }

        #generateSpinner::before {
            content: "";
            width: 16px;
            height: 16px;
            border: 3px solid #e0e0e0;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ---------- Table ---------- */

        table {
            border-collapse: collapse;
            margin-top: 1em;
            width: 100%;
            background: #ffffff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #3498db;
            color: white;
            font-weight: normal;
        }

        tbody tr:nth-child(odd) {
            background-color: #f7faff;
        }

        tbody tr:hover {
            background-color: #eef5ff;
        }

        .warn {
            color: #b00020;
            font-weight: bold;
        }

        /* ---------- Icon Buttons ---------- */

        td {
            text-align: center;
            vertical-align: middle;
        }

        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;

            min-width: 36px;
            padding: 6px 10px;

            font-size: 1.1em;
            cursor: pointer;

            background-color: #eef5ff;
            border: 1px solid #cfe1f7;
            border-radius: 6px;

            color: #0e2a3d;
            transition:
                    background-color 0.15s ease,
                    box-shadow 0.15s ease,
                    transform 0.05s ease;
        }

        .icon-btn:hover {
            background-color: #dbeeff;
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
        }

        .icon-btn:active {
            transform: translateY(1px);
        }

        .icon-btn:disabled {
            background-color: #f0f0f0;
            border-color: #ddd;
            color: #aaa;
            cursor: not-allowed;
        }

        /* If the icon button is the ONLY thing in the cell, stretch it */
        td > .icon-btn:only-child {
            width: 100%;
        }
        .icon-btn:hover {
            background-color: rgba(52, 152, 219, 0.15);
        }

        /* ---------- Modals ---------- */

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
        }

        .modal-content {
            background: #ffffff;
            max-width: 420px;
            margin: 10% auto;
            padding: 1.2em;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        }

        .modal-content h3 {
            margin-top: 0;
            color: #0e2a3d;
        }

        .modal-actions {
            margin-top: 1.2em;
            display: flex;
            justify-content: space-between;
        }

        /* ---------- Results ---------- */

        .success {
            background-color: #e8f5e9;
            border: 1px solid #4caf50;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
        }

        .error {
            background-color: #ffebee;
            border: 1px solid #e57373;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            white-space: pre-wrap;
        }

        /* ---------- Toast ---------- */

        #toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 0.6em 1em;
            border-radius: 6px;
            display: none;
            z-index: 2000;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .verify-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid currentColor;
            border-radius: 50%;
            position: relative;
        }

        /* The checkmark */
        .verify-icon::after {
            content: "";
            position: absolute;
            left: 4px;
            top: 0px;
            width: 6px;
            height: 12px;
            border-right: 3px solid currentColor;
            border-bottom: 3px solid currentColor;
            transform: rotate(45deg);
        }
        .verify-btn { color: #777; }        /* unverified */
        .verify-btn.verified { color: #1e7e34; } /* verified green */


    </style>

</head>
<body>

<h2>Generate Salesforce JWT Certificate</h2>

<form id="generateForm">
    <div>
        CN:
        <input name="cn" required placeholder="salesforce-prod" />
    </div>
    <div>
        Validity days:
        <input name="days" value="1200" />
    </div>
    <button type="submit">Generate</button>
    <div id="generateSpinner" style="display:none;">
        ‚è≥ Generating certificate‚Ä¶
    </div>
</form>

<hr/>

<h2>Existing certificates</h2>
<button onclick="loadCerts()">Refresh</button>

<table>
    <thead>
    <tr>
        <th>CN</th>
        <th>Expires</th>
        <th>Days left</th>
        <th>Cert file</th>
        <th>KEYSTORE_JKS_B64</th>
        <th>KEYSTORE_PASSWORD</th>
        <th>Verify</th>
        <th>SF_CLIENT_ID</th>
        <th>SF_USERNAME</th>
        <th></th>
    </tr>
    </thead>
    <tbody id="certTable"></tbody>
</table>

<button onclick="flushLocal()" style="margin-top: 1em;">
    üßπ Flush local certificate cache
</button>

<!-- Test Modal -->
<div id="testModal" class="modal">
    <div class="modal-content">
        <h3>Test certificate</h3>

        <div>
            CN:
            <input id="testCn" readonly />
        </div>

        <div>
            Salesforce Client ID:
            <input id="testClientId" />
        </div>

        <div>
            Salesforce Username:
            <input id="testUsername" />
        </div>

        <div id="testResult"></div>

        <div class="modal-actions">
            <button onclick="runTest()">Test</button>
            <button onclick="closeModal()">Close</button>
        </div>
    </div>
</div>
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <h3 id="confirmTitle"></h3>
        <p id="confirmMessage"></p>

        <div class="modal-actions">
            <button type="button" onclick="closeConfirmModal()">Cancel</button>
            <button type="button" id="confirmOkButton">Confirm</button>
        </div>
    </div>
</div>
<div id="toast" style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #333;
    color: white;
    padding: 0.6em 1em;
    border-radius: 4px;
    display: none;
    z-index: 1000;
">

<script>
    let currentTestCn = null;
    let existingCns = new Set();

    async function loadCerts() {
        const res = await fetch("/internal/cert/list");
        const list = await res.json();

        const tbody = document.getElementById("certTable");
        tbody.innerHTML = "";

        existingCns.clear()
        list.forEach(c => {
            existingCns.add(c.cn);

            const tr = document.createElement("tr");
            const warn = c.daysLeft < 60 ? "warn" : "";

            const isTmp = c.source === "tmp";

            tr.innerHTML = `
  <td>${c.cn}</td>
  <td>${c.expiresAt}</td>
  <td class="${warn}">${c.daysLeft}</td>

      <td>
        ${isTmp
                ? `<button class="icon-btn" title="Download certificate"
                 onclick="download('${c.cn}', 'cer')">‚¨áÔ∏è</button>`
                : ``}
      </td>

      <td>
        ${isTmp
                ? `<button class="icon-btn" title="Copy JKS Base64"
                 onclick="copy('${c.cn}', 'jksb64')">üìã</button>`
                : ``}
      </td>

      <td>
        ${isTmp
                ? `<button class="icon-btn" title="Copy keystore password"
                 onclick="copy('${c.cn}', 'password')">üìã</button>`
                : ``}
      </td>

      <td>
        ${isTmp
                ? `<button class="icon-btn verify-btn" title="Verify against Salesforce"
                 onclick="openTestModal('${c.cn}')"><span class="verify-icon"></span></button>`
                : ``}
      </td>

      <td>
  ${
                isTmp && c.sfClientId
                    ? `<button class="icon-btn"
           title="Copy SF Client ID"
           onclick="copyValue('${c.sfClientId}')">üìã</button>`
                    : (!isTmp && c.sfClientId
                        ? `<span title="Masked Client ID">${c.sfClientId}</span>`
                        : ``)
            }
</td>

      <td>
  ${
                isTmp && c.sfUsername
                    ? `<button class="icon-btn"
           title="Copy SF Username"
           onclick="copyValue('${c.sfUsername}')">üìã</button>`
                    : (!isTmp && c.sfUsername
                        ? `<span title="Integration user">${c.sfUsername}</span>`
                        : ``)
            }
</td>
      <td>
  <button class="icon-btn" title="Delete certificate"
    onclick="deleteCert('${c.cn}', '${c.source}')">üóë</button>
</td>
`;
            tbody.appendChild(tr);
        });
    }

    function copyValue(value) {
        navigator.clipboard.writeText(value);
        showToast("Copied to clipboard");
    }

    function download(cn, type) {
        window.location = `/internal/cert/download/${cn}/${type}`;
    }

    async function copy(cn, type) {
        const res = await fetch(`/internal/cert/download/${cn}/${type}`);
        const text = await res.text();
        await navigator.clipboard.writeText(text);
        showToast("Copied to clipboard");
    }

    /* ----- Modal ----- */

    function openTestModal(cn) {
        currentTestCn = cn;
        document.getElementById("testCn").value = cn;
        document.getElementById("testResult").innerHTML = "";
        document.getElementById("testModal").style.display = "block";
    }

    function closeModal() {
        document.getElementById("testModal").style.display = "none";
    }

    function showToast(msg) {
        const t = document.getElementById("toast");
        t.textContent = msg;
        t.style.display = "block";

        setTimeout(() => {
            t.style.display = "none";
        }, 1500);
    }

    async function runTest() {
        const clientId = document.getElementById("testClientId").value;
        const username = document.getElementById("testUsername").value;

        const result = document.getElementById("testResult");
        result.textContent = "Testing...";
        result.className = "";

        const body = new URLSearchParams({
            cn: currentTestCn,
            clientId,
            username
        });

        const res = await fetch("/internal/cert/test", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body
        });

        const text = await res.text();
        result.textContent = text;
        result.className = res.ok ? "success" : "error";
        await loadCerts();
    }

    function deleteCert(cn, source) {
        openConfirmModal(
            "Delete certificate",
            `Delete certificate '${cn}'?\n\nThis cannot be undone.`,
            async () => {
                console.log("DELETE CERT delegated function");
                const body = new URLSearchParams({ cn, source });

                const res = await fetch("/internal/cert/delete", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body
                });

                if (!res.ok) {
                    showToast(await res.text());
                    return;
                }

                await loadCerts();
            }
        );
    }

    function flushLocal() {
        openConfirmModal(
            "Flush local certificate cache",
            "This will remove ALL locally stored certificates and secrets.\n\n" +
            "Database metadata will remain.",
            async () => {
                const res = await fetch("/internal/cert/flush", {
                    method: "POST"
                });

                if (!res.ok) {
                    showToast(await res.text());
                    return;
                }

                await loadCerts();
            }
        );
    }

    let confirmCallback = null;

    function openConfirmModal(title, message, onConfirm) {
        document.getElementById("confirmTitle").innerText = title;
        document.getElementById("confirmMessage").innerText = message;

        confirmCallback = onConfirm;

        document.getElementById("confirmModal").style.display = "block";

        document.getElementById("confirmOkButton").onclick = () => {
            const cb = confirmCallback;
            closeConfirmModal();
            cb && cb();
        };
    }

    function closeConfirmModal() {
        document.getElementById("confirmModal").style.display = "none";
        confirmCallback = null;
    }


    /* ----- Generate ----- */

    document.getElementById("generateForm").onsubmit = async e => {
        e.preventDefault();
        const f = e.target;
        const spinner = document.getElementById("generateSpinner");
        const cn = f.cn.value.trim();

        if (existingCns.has(cn)) {
            showToast(`Certificate with CN '${cn}' already exists`);
            return;
        }

        spinner.style.display = "block";
        f.querySelector("button").disabled = true;

        const body = new URLSearchParams({
            cn: cn,
            days: f.days.value
        });

        try {
            const res = await fetch("/internal/cert/generate", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body
            });

            if (!res.ok) {
                showToast(await res.text());
            } else {
                f.reset();
                await loadCerts();
            }
        } finally {
            spinner.style.display = "none";
            f.querySelector("button").disabled = false;
        }
    };

    loadCerts();
</script>

</body>
</html>
