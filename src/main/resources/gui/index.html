<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Salesforce JWT Certificate Tool</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        input { margin: 0.3em 0; width: 100%; }
        button { margin-top: 0.5em; }
        table { border-collapse: collapse; margin-top: 1em; width: 100%; }
        th, td { border: 1px solid #ccc; padding: 0.4em 0.6em; }
        th { background: #f3f3f3; }
        .warn { color: darkred; }
        .icon-btn {
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1.1em;
            margin-right: 0.4em;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
        }
        .modal-content {
            background: #fff;
            max-width: 420px;
            margin: 10% auto;
            padding: 1em;
            border-radius: 4px;
        }
        .modal-actions {
            margin-top: 1em;
            text-align: right;
        }
        .success { color: green; }
        .error { color: darkred; white-space: pre-wrap; }
    </style>
</head>
<body>

<h2>Generate Salesforce JWT Certificate</h2>

<form id="generateForm">
    <div>
        CN:
        <input name="cn" required placeholder="salesforce-prod" />
    </div>
    <div>
        Validity days:
        <input name="days" value="1200" />
    </div>
    <button type="submit">Generate</button>
    <div id="generateSpinner" style="display:none;">
        ‚è≥ Generating certificate‚Ä¶
    </div>
</form>

<hr/>

<h2>Existing certificates</h2>
<button onclick="loadCerts()">Refresh</button>

<table>
    <thead>
    <tr>
        <th>CN</th>
        <th>Expires</th>
        <th>Days left</th>
        <th>Cert file</th>
        <th>KEYSTORE_JKS_B64</th>
        <th>KEYSTORE_PASSWORD</th>
        <th>Verify</th>
        <th>SF_CLIENT_ID</th>
        <th>SF_USERNAME</th>
        <th></th>
    </tr>
    </thead>
    <tbody id="certTable"></tbody>
</table>

<button onclick="flushLocal()" style="margin-top: 1em;">
    üßπ Flush local certificate cache
</button>

<!-- Test Modal -->
<div id="testModal" class="modal">
    <div class="modal-content">
        <h3>Test certificate</h3>

        <div>
            CN:
            <input id="testCn" readonly />
        </div>

        <div>
            Salesforce Client ID:
            <input id="testClientId" />
        </div>

        <div>
            Salesforce Username:
            <input id="testUsername" />
        </div>

        <div id="testResult"></div>

        <div class="modal-actions">
            <button onclick="runTest()">Test</button>
            <button onclick="closeModal()">Close</button>
        </div>
    </div>
</div>
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <h3 id="confirmTitle"></h3>
        <p id="confirmMessage"></p>

        <div class="modal-actions">
            <button type="button" onclick="closeConfirmModal()">Cancel</button>
            <button type="button" id="confirmOkButton">Confirm</button>
        </div>
    </div>
</div>

<script>
    let currentTestCn = null;
    let existingCns = new Set();

    async function loadCerts() {
        const res = await fetch("/internal/cert/list");
        const list = await res.json();

        const tbody = document.getElementById("certTable");
        tbody.innerHTML = "";

        existingCns.clear()
        list.forEach(c => {
            existingCns.add(c.cn);

            const tr = document.createElement("tr");
            const warn = c.daysLeft < 60 ? "warn" : "";

            const isTmp = c.source === "tmp";

            tr.innerHTML = `
  <td>${c.cn}</td>
  <td>${c.expiresAt}</td>
  <td class="${warn}">${c.daysLeft}</td>

      <td>
        ${isTmp
                ? `<button class="icon-btn" title="Download certificate"
                 onclick="download('${c.cn}', 'cer')">‚¨áÔ∏è</button>`
                : ``}
      </td>

      <td>
        ${isTmp
                ? `<button class="icon-btn" title="Copy JKS Base64"
                 onclick="copy('${c.cn}', 'jksb64')">üìã</button>`
                : ``}
      </td>

      <td>
        ${isTmp
                ? `<button class="icon-btn" title="Copy keystore password"
                 onclick="copy('${c.cn}', 'password')">üìã</button>`
                : ``}
      </td>

      <td>
        ${isTmp
                ? `<button class="icon-btn" title="Verify against Salesforce"
                 onclick="openTestModal('${c.cn}')">üß™</button>`
                : ``}
      </td>

      <td>
  ${
                isTmp && c.sfClientId
                    ? `<button class="icon-btn"
           title="Copy SF Client ID"
           onclick="copyValue('${c.sfClientId}')">üìã</button>`
                    : (!isTmp && c.sfClientId
                        ? `<span title="Masked Client ID">${c.sfClientId}</span>`
                        : ``)
            }
</td>

      <td>
  ${
                isTmp && c.sfUsername
                    ? `<button class="icon-btn"
           title="Copy SF Username"
           onclick="copyValue('${c.sfUsername}')">üìã</button>`
                    : (!isTmp && c.sfUsername
                        ? `<span title="Integration user">${c.sfUsername}</span>`
                        : ``)
            }
</td>
      <td>
  <button class="icon-btn" title="Delete certificate"
    onclick="deleteCert('${c.cn}', '${c.source}')">üóë</button>
</td>
`;
            tbody.appendChild(tr);
        });
    }

    function copyValue(value) {
        navigator.clipboard.writeText(value);
        alert("Copied to clipboard");
    }

    function download(cn, type) {
        window.location = `/internal/cert/download/${cn}/${type}`;
    }

    async function copy(cn, type) {
        const res = await fetch(`/internal/cert/download/${cn}/${type}`);
        const text = await res.text();
        await navigator.clipboard.writeText(text);
        alert("Copied to clipboard");
    }

    /* ----- Modal ----- */

    function openTestModal(cn) {
        currentTestCn = cn;
        document.getElementById("testCn").value = cn;
        document.getElementById("testResult").innerHTML = "";
        document.getElementById("testModal").style.display = "block";
    }

    function closeModal() {
        document.getElementById("testModal").style.display = "none";
    }

    async function runTest() {
        const clientId = document.getElementById("testClientId").value;
        const username = document.getElementById("testUsername").value;

        const result = document.getElementById("testResult");
        result.textContent = "Testing...";
        result.className = "";

        const body = new URLSearchParams({
            cn: currentTestCn,
            clientId,
            username
        });

        const res = await fetch("/internal/cert/test", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body
        });

        const text = await res.text();
        result.textContent = text;
        result.className = res.ok ? "success" : "error";
        await loadCerts();
    }

    function deleteCert(cn, source) {
        openConfirmModal(
            "Delete certificate",
            `Delete certificate '${cn}'?\n\nThis cannot be undone.`,
            async () => {
                console.log("DELETE CERT delegated function");
                const body = new URLSearchParams({ cn, source });

                const res = await fetch("/internal/cert/delete", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body
                });

                if (!res.ok) {
                    alert(await res.text());
                    return;
                }

                await loadCerts();
            }
        );
    }

    function flushLocal() {
        openConfirmModal(
            "Flush local certificate cache",
            "This will remove ALL locally stored certificates and secrets.\n\n" +
            "Database metadata will remain.",
            async () => {
                const res = await fetch("/internal/cert/flush", {
                    method: "POST"
                });

                if (!res.ok) {
                    alert(await res.text());
                    return;
                }

                await loadCerts();
            }
        );
    }

    let confirmCallback = null;

    function openConfirmModal(title, message, onConfirm) {
        document.getElementById("confirmTitle").innerText = title;
        document.getElementById("confirmMessage").innerText = message;

        confirmCallback = onConfirm;

        document.getElementById("confirmModal").style.display = "block";

        document.getElementById("confirmOkButton").onclick = () => {
            const cb = confirmCallback;
            closeConfirmModal();
            cb && cb();
        };
    }

    function closeConfirmModal() {
        document.getElementById("confirmModal").style.display = "none";
        confirmCallback = null;
    }


    /* ----- Generate ----- */

    document.getElementById("generateForm").onsubmit = async e => {
        e.preventDefault();
        const f = e.target;
        const spinner = document.getElementById("generateSpinner");
        const cn = f.cn.value.trim();

        if (existingCns.has(cn)) {
            alert(`Certificate with CN '${cn}' already exists`);
            return;
        }

        spinner.style.display = "block";
        f.querySelector("button").disabled = true;

        const body = new URLSearchParams({
            cn: cn,
            days: f.days.value
        });

        try {
            const res = await fetch("/internal/cert/generate", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body
            });

            if (!res.ok) {
                alert(await res.text());
            } else {
                f.reset();
                await loadCerts();
            }
        } finally {
            spinner.style.display = "none";
            f.querySelector("button").disabled = false;
        }
    };

    loadCerts();
</script>

</body>
</html>
