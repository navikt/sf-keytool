<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Salesforce JWT Certificate Tool</title>

    <!-- Aksel CSS -->
    <link
            rel="stylesheet"
            href="https://cdn.nav.no/aksel/aksel.css"
    />

    <style>
        body {
            font-family: var(--a-font-family-default);
            background: var(--a-bg-default);
            margin: 0;
            padding: var(--a-spacing-8);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .section {
            margin-bottom: var(--a-spacing-10);
        }

        .warn {
            color: var(--a-text-danger);
            font-weight: 600;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
        }

        /* Modal (Aksel-styled, men JS-styrt) */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
        }

        .modal-content {
            background: var(--a-surface-default);
            max-width: 480px;
            margin: 10vh auto;
            padding: var(--a-spacing-6);
            border-radius: var(--a-border-radius-large);
            box-shadow: var(--a-shadow-large);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--a-spacing-4);
            margin-top: var(--a-spacing-6);
        }

        .success {
            color: var(--a-text-success);
            white-space: pre-wrap;
        }

        .error {
            color: var(--a-text-danger);
            white-space: pre-wrap;
        }

        /* Toast */
        #toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--a-surface-inverted);
            color: var(--a-text-on-inverted);
            padding: var(--a-spacing-4) var(--a-spacing-6);
            border-radius: var(--a-border-radius-medium);
            display: none;
            z-index: 2000;
        }
    </style>
</head>

<body>
<div class="container">

    <h1 class="navds-heading navds-heading--large section">
        Salesforce JWT Certificate Tool
    </h1>

    <!-- Generate -->
    <section class="section">
        <h2 class="navds-heading navds-heading--medium">Generate certificate</h2>

        <form id="generateForm" class="navds-stack navds-stack--gap-6">
            <div class="navds-form-field">
                <label class="navds-label">CN</label>
                <input
                        class="navds-text-field__input"
                        name="cn"
                        required
                        placeholder="salesforce-prod"
                />
            </div>

            <div class="navds-form-field">
                <label class="navds-label">Validity days</label>
                <input
                        class="navds-text-field__input"
                        name="days"
                        value="1200"
                />
            </div>

            <div>
                <button type="submit" class="navds-button navds-button--primary">
                    Generate
                </button>
            </div>

            <div id="generateSpinner" style="display:none;">
                ‚è≥ Generating certificate‚Ä¶
            </div>
        </form>
    </section>

    <!-- Existing certificates -->
    <section class="section">
        <div class="navds-stack navds-stack--gap-4 navds-stack--direction-row">
            <h2 class="navds-heading navds-heading--medium">Existing certificates</h2>
            <button
                    class="navds-button navds-button--secondary"
                    onclick="loadCerts()"
            >
                Refresh
            </button>
        </div>

        <table class="navds-table">
            <thead class="navds-table__header">
            <tr class="navds-table__row">
                <th class="navds-table__header-cell">CN</th>
                <th class="navds-table__header-cell">Expires</th>
                <th class="navds-table__header-cell">Days left</th>
                <th class="navds-table__header-cell">Cert</th>
                <th class="navds-table__header-cell">JKS</th>
                <th class="navds-table__header-cell">Password</th>
                <th class="navds-table__header-cell">Verify</th>
                <th class="navds-table__header-cell">Client ID</th>
                <th class="navds-table__header-cell">Username</th>
                <th class="navds-table__header-cell"></th>
            </tr>
            </thead>
            <tbody id="certTable" class="navds-table__body"></tbody>
        </table>

        <div style="margin-top: var(--a-spacing-6);">
            <button
                    class="navds-button navds-button--danger"
                    onclick="flushLocal()"
            >
                Flush local certificate cache
            </button>
        </div>
    </section>
</div>

<!-- Test Modal -->
<div id="testModal" class="modal">
    <div class="modal-content">
        <h3 class="navds-heading navds-heading--small">Test certificate</h3>

        <div class="navds-form-field">
            <label class="navds-label">CN</label>
            <input id="testCn" class="navds-text-field__input" readonly />
        </div>

        <div class="navds-form-field">
            <label class="navds-label">Salesforce Client ID</label>
            <input id="testClientId" class="navds-text-field__input" />
        </div>

        <div class="navds-form-field">
            <label class="navds-label">Salesforce Username</label>
            <input id="testUsername" class="navds-text-field__input" />
        </div>

        <div id="testResult"></div>

        <div class="modal-actions">
            <button class="navds-button navds-button--primary" onclick="runTest()">Test</button>
            <button class="navds-button navds-button--secondary" onclick="closeModal()">Close</button>
        </div>
    </div>
</div>

<!-- Confirm Modal -->
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <h3 id="confirmTitle" class="navds-heading navds-heading--small"></h3>
        <p id="confirmMessage"></p>

        <div class="modal-actions">
            <button class="navds-button navds-button--secondary" onclick="closeConfirmModal()">Cancel</button>
            <button class="navds-button navds-button--danger" id="confirmOkButton">
                Confirm
            </button>
        </div>
    </div>
</div>

<div id="toast"></div>

<script>
    let currentTestCn = null;
    let existingCns = new Set();

    async function loadCerts() {
        const res = await fetch("/internal/cert/list");
        const list = await res.json();

        const tbody = document.getElementById("certTable");
        tbody.innerHTML = "";

        existingCns.clear()
        list.forEach(c => {
            existingCns.add(c.cn);

            const tr = document.createElement("tr");
            const warn = c.daysLeft < 60 ? "warn" : "";

            const isTmp = c.source === "tmp";

            tr.innerHTML = `
  <td>${c.cn}</td>
  <td>${c.expiresAt}</td>
  <td class="${warn}">${c.daysLeft}</td>

      <td>
        ${isTmp
                ? `<button class="icon-btn" title="Download certificate"
                 onclick="download('${c.cn}', 'cer')">‚¨áÔ∏è</button>`
                : ``}
      </td>

      <td>
        ${isTmp
                ? `<button class="icon-btn" title="Copy JKS Base64"
                 onclick="copy('${c.cn}', 'jksb64')">üìã</button>`
                : ``}
      </td>

      <td>
        ${isTmp
                ? `<button class="icon-btn" title="Copy keystore password"
                 onclick="copy('${c.cn}', 'password')">üìã</button>`
                : ``}
      </td>

      <td>
        ${isTmp
                ? `<button class="icon-btn" title="Verify against Salesforce"
                 onclick="openTestModal('${c.cn}')">üß™</button>`
                : ``}
      </td>

      <td>
  ${
                isTmp && c.sfClientId
                    ? `<button class="icon-btn"
           title="Copy SF Client ID"
           onclick="copyValue('${c.sfClientId}')">üìã</button>`
                    : (!isTmp && c.sfClientId
                        ? `<span title="Masked Client ID">${c.sfClientId}</span>`
                        : ``)
            }
</td>

      <td>
  ${
                isTmp && c.sfUsername
                    ? `<button class="icon-btn"
           title="Copy SF Username"
           onclick="copyValue('${c.sfUsername}')">üìã</button>`
                    : (!isTmp && c.sfUsername
                        ? `<span title="Integration user">${c.sfUsername}</span>`
                        : ``)
            }
</td>
      <td>
  <button class="icon-btn" title="Delete certificate"
    onclick="deleteCert('${c.cn}', '${c.source}')">üóë</button>
</td>
`;
            tbody.appendChild(tr);
        });
    }

    function copyValue(value) {
        navigator.clipboard.writeText(value);
        showToast("Copied to clipboard");
    }

    function download(cn, type) {
        window.location = `/internal/cert/download/${cn}/${type}`;
    }

    async function copy(cn, type) {
        const res = await fetch(`/internal/cert/download/${cn}/${type}`);
        const text = await res.text();
        await navigator.clipboard.writeText(text);
        showToast("Copied to clipboard");
    }

    /* ----- Modal ----- */

    function openTestModal(cn) {
        currentTestCn = cn;
        document.getElementById("testCn").value = cn;
        document.getElementById("testResult").innerHTML = "";
        document.getElementById("testModal").style.display = "block";
    }

    function closeModal() {
        document.getElementById("testModal").style.display = "none";
    }

    function showToast(msg) {
        const t = document.getElementById("toast");
        t.textContent = msg;
        t.style.display = "block";

        setTimeout(() => {
            t.style.display = "none";
        }, 1500);
    }

    async function runTest() {
        const clientId = document.getElementById("testClientId").value;
        const username = document.getElementById("testUsername").value;

        const result = document.getElementById("testResult");
        result.textContent = "Testing...";
        result.className = "";

        const body = new URLSearchParams({
            cn: currentTestCn,
            clientId,
            username
        });

        const res = await fetch("/internal/cert/test", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body
        });

        const text = await res.text();
        result.textContent = text;
        result.className = res.ok ? "success" : "error";
        await loadCerts();
    }

    function deleteCert(cn, source) {
        openConfirmModal(
            "Delete certificate",
            `Delete certificate '${cn}'?\n\nThis cannot be undone.`,
            async () => {
                console.log("DELETE CERT delegated function");
                const body = new URLSearchParams({ cn, source });

                const res = await fetch("/internal/cert/delete", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body
                });

                if (!res.ok) {
                    showToast(await res.text());
                    return;
                }

                await loadCerts();
            }
        );
    }

    function flushLocal() {
        openConfirmModal(
            "Flush local certificate cache",
            "This will remove ALL locally stored certificates and secrets.\n\n" +
            "Database metadata will remain.",
            async () => {
                const res = await fetch("/internal/cert/flush", {
                    method: "POST"
                });

                if (!res.ok) {
                    showToast(await res.text());
                    return;
                }

                await loadCerts();
            }
        );
    }

    let confirmCallback = null;

    function openConfirmModal(title, message, onConfirm) {
        document.getElementById("confirmTitle").innerText = title;
        document.getElementById("confirmMessage").innerText = message;

        confirmCallback = onConfirm;

        document.getElementById("confirmModal").style.display = "block";

        document.getElementById("confirmOkButton").onclick = () => {
            const cb = confirmCallback;
            closeConfirmModal();
            cb && cb();
        };
    }

    function closeConfirmModal() {
        document.getElementById("confirmModal").style.display = "none";
        confirmCallback = null;
    }


    /* ----- Generate ----- */

    document.getElementById("generateForm").onsubmit = async e => {
        e.preventDefault();
        const f = e.target;
        const spinner = document.getElementById("generateSpinner");
        const cn = f.cn.value.trim();

        if (existingCns.has(cn)) {
            showToast(`Certificate with CN '${cn}' already exists`);
            return;
        }

        spinner.style.display = "block";
        f.querySelector("button").disabled = true;

        const body = new URLSearchParams({
            cn: cn,
            days: f.days.value
        });

        try {
            const res = await fetch("/internal/cert/generate", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body
            });

            if (!res.ok) {
                showToast(await res.text());
            } else {
                f.reset();
                await loadCerts();
            }
        } finally {
            spinner.style.display = "none";
            f.querySelector("button").disabled = false;
        }
    };

    loadCerts();
</script>

</body>
</html>
